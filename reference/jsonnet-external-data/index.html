<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.88.1" />
    <meta name="description" content="a tool to configure and create Kubernetes objects on multiple environments">


    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Jsonnet data importer :: Qbec</title>

    
    <link href="/css/nucleus.css" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css" rel="stylesheet">
    <link href="/css/hybrid.css" rel="stylesheet">
    <link href="/css/featherlight.min.css" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="/css/auto-complete.css" rel="stylesheet">
    <link href="/css/theme.css" rel="stylesheet">
    <link href="/css/hugo-theme.css" rel="stylesheet">
    
      <link href="/css/theme-blue.css" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    <style type="text/css">
    h1 {
        text-align: left;
        border-bottom: 4px solid #F0F2F4;
    }
    #chapter h1 {
        text-align: center !important;
    }
    #chapter p {
        text-align: left !important;
    }
    section#shortcuts h3 {
        display: none;
    }
</style>

  </head>
  <body class="" data-url="/reference/jsonnet-external-data/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="http://qbec.io">

<img width="50%" src="/images/qbec-logo-white.svg">

</a>

    </div>
    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/getting-started/" title="Getting started" class="dd-item 
        
        
        
        ">
      <a href="/getting-started/">
          Getting started
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/userguide/" title="User guide" class="dd-item 
        
        
        
        ">
      <a href="/userguide/">
          User guide
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/userguide/tour/" title="A quick tour of qbec" class="dd-item ">
        <a href="/userguide/tour/">
        A quick tour of qbec
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/userguide/model/" title="Core concepts" class="dd-item ">
        <a href="/userguide/model/">
        Core concepts
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/userguide/usage/" title="Using qbec" class="dd-item 
        
        
        
        ">
      <a href="/userguide/usage/">
          Using qbec
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/userguide/usage/basic/" title="Folders, files, parameters" class="dd-item ">
        <a href="/userguide/usage/basic/">
        Folders, files, parameters
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/userguide/usage/authoring/" title="Create components" class="dd-item ">
        <a href="/userguide/usage/authoring/">
        Create components
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/userguide/usage/common-metadata/" title="Common object metadata" class="dd-item ">
        <a href="/userguide/usage/common-metadata/">
        Common object metadata
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/userguide/usage/runtime-params/" title="Runtime parameters" class="dd-item ">
        <a href="/userguide/usage/runtime-params/">
        Runtime parameters
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/userguide/usage/branches-and-ci/" title="Branch builds and CI" class="dd-item ">
        <a href="/userguide/usage/branches-and-ci/">
        Branch builds and CI
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/userguide/usage/directives/" title="Controlling qbec behavior" class="dd-item ">
        <a href="/userguide/usage/directives/">
        Controlling qbec behavior
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/userguide/usage/commands/" title="Running qbec commands" class="dd-item ">
        <a href="/userguide/usage/commands/">
        Running qbec commands
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/userguide/usage/tips-and-tricks/" title="Tips and tricks" class="dd-item ">
        <a href="/userguide/usage/tips-and-tricks/">
        Tips and tricks
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/reference/" title="Reference" class="dd-item 
        parent
        
        
        ">
      <a href="/reference/">
          Reference
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/qbec-yaml/" title="Application YAML" class="dd-item ">
        <a href="/reference/qbec-yaml/">
        Application YAML
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/directives/" title="Qbec directives" class="dd-item ">
        <a href="/reference/directives/">
        Qbec directives
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/jsonnet-vars/" title="Standard jsonnet variables" class="dd-item ">
        <a href="/reference/jsonnet-vars/">
        Standard jsonnet variables
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/gen-metadata/" title="Metadata for K8s objects" class="dd-item ">
        <a href="/reference/gen-metadata/">
        Metadata for K8s objects
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/jsonnet-native-funcs/" title="Jsonnet native functions" class="dd-item ">
        <a href="/reference/jsonnet-native-funcs/">
        Jsonnet native functions
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/jsonnet-glob-importer/" title="Jsonnet glob importer" class="dd-item ">
        <a href="/reference/jsonnet-glob-importer/">
        Jsonnet glob importer
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/jsonnet-external-data/" title="Jsonnet data importer" class="dd-item active">
        <a href="/reference/jsonnet-external-data/">
        Jsonnet data importer
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/component-evaluation/" title="Component evaluation" class="dd-item ">
        <a href="/reference/component-evaluation/">
        Component evaluation
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/diffs-and-patches/" title="Diffs and patches" class="dd-item ">
        <a href="/reference/diffs-and-patches/">
        Diffs and patches
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/garbage-collection/" title="Garbage collection" class="dd-item ">
        <a href="/reference/garbage-collection/">
        Garbage collection
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/comparison-with-other-tools/" title="Comparison with other tools" class="dd-item 
        
        
        
        ">
      <a href="/comparison-with-other-tools/">
          Comparison with other tools
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/splunk/qbec"><i class='fab fa-github'></i> Github repo</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      
    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                  
                  
                  
                  <div id="top-github-link">
                    <a class="github-link" title='Edit this page' href="https://github.com/splunk/qbec/edit/main/site/content/reference/jsonnet-external-data.md" target="blank">
                      <i class="fas fa-code-branch"></i>
                      <span id="top-github-link-text">Edit this page</span>
                    </a>
                  </div>
                  
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Home</a> > <a href='/reference/'>Reference</a> > Jsonnet data importer
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#step-1-specify-a-configuration-for-command-invocation">Step 1: Specify a configuration for command invocation</a></li>
        <li><a href="#step-2-create-a-data-source-that-refers-to-this-configuration">Step 2: Create a data source that refers to this configuration</a></li>
        <li><a href="#step-3-use-this-data-source-in-your-jsonnet-component-code">Step 3: use this data source in your jsonnet component code</a></li>
      </ul>
    </li>
    <li><a href="#usage-notes">Usage notes</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Jsonnet data importer</h1>
          

        


<p>Sometimes you need to generate data using external programs and be able to access it in your jsonnet components.
This can be accomplished using the data source importer that ships with qbec.</p>
<p>While the design of the importer allows for tight, native integration with tools like <code>helm</code>, <code>istioctl</code>, <code>kustomize</code>,
and secret engines like <code>vault</code>, the only integration that is currently implemented is <code>exec</code> that allows you to
run external programs and use the standard output they produce as data in jsonnet code.</p>
<p>The <a href="https://github.com/splunk/qbec/tree/main/examples/external-data-app">sample data app</a> provides a working
implementation of such an importer and demonstrates everything that you need to do to set it up.</p>
<p>The recipe for pulling in additional data from external command output consists of 3 parts:</p>
<h3 id="step-1-specify-a-configuration-for-command-invocation">Step 1: Specify a configuration for command invocation</h3>
<p>This includes program name, arguments, environment variables, and standard input. This is a JSON object with the following properties:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;command&#34;</span>: <span style="color:#e6db74">&#34;/path/to/executable&#34;</span>,
  <span style="color:#f92672">&#34;args&#34;</span>: [ <span style="color:#e6db74">&#34;array&#34;</span>, <span style="color:#e6db74">&#34;of&#34;</span>, <span style="color:#e6db74">&#34;positional&#34;</span>, <span style="color:#e6db74">&#34;arguments&#34;</span>],
  <span style="color:#f92672">&#34;env&#34;</span>: {
    <span style="color:#f92672">&#34;map&#34;</span>: <span style="color:#e6db74">&#34;of&#34;</span>,
    <span style="color:#f92672">&#34;environment&#34;</span>: <span style="color:#e6db74">&#34;variables&#34;</span>,
  },
  <span style="color:#f92672">&#34;stdin&#34;</span>: <span style="color:#e6db74">&#34;standard input to program as a string&#34;</span>,
  <span style="color:#f92672">&#34;inheritEnv&#34;</span>: <span style="color:#66d9ef">false</span>,
  <span style="color:#f92672">&#34;timeout&#34;</span>: <span style="color:#e6db74">&#34;10s&#34;</span>
}
</code></pre></div><p>You construct this object using an external code variable that can be defined in qbec.yaml.
Now, some arguments can be different based on the qbec environment.
This can be accomplished using computed variables that qbec supports. Computed variables are defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
    <span style="color:#f92672">vars</span>:
      <span style="color:#f92672">computed</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cmdConfig</span>
          <span style="color:#f92672">code</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">            {
</span><span style="color:#e6db74">              command: &#39;myCommand.sh&#39;,
</span><span style="color:#e6db74">              args: [ &#39;--env&#39;, std.extVar(&#39;qbec.io/env&#39;) ],
</span><span style="color:#e6db74">            }</span>            
</code></pre></div><p>In the example above, the arguments to the command are constructed dynamically based on the qbec environment.</p>
<h3 id="step-2-create-a-data-source-that-refers-to-this-configuration">Step 2: Create a data source that refers to this configuration</h3>
<p>Add a &ldquo;data source&rdquo; to qbec.yaml as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">spec</span>:
  <span style="color:#f92672">dataSources</span>:
    - <span style="color:#ae81ff">exec://my-data-source?configVar=cmdConfig</span>
</code></pre></div><p>The above URL has 3 parts.</p>
<ul>
<li>The scheme of the URL is <code>exec</code> which is the kind of data source that is being created. Currently, only <code>exec</code> is
allowed, but we could add more schemes in the future for native integrations with specific tools.</li>
<li>The hostname in the URL is a name of your choosing. This is the data source name.</li>
<li>The <code>configVar</code> query parameter is the reference to the configuration variable using which the data source is
initialized.</li>
</ul>
<h3 id="step-3-use-this-data-source-in-your-jsonnet-component-code">Step 3: use this data source in your jsonnet component code</h3>
<pre tabindex="0"><code class="language-jsonnet" data-lang="jsonnet">import 'data://my-data-source/some/path'
</code></pre><ul>
<li>The <code>data</code> scheme in the URI above allows qbec to determine that you want to import external data.</li>
<li>The hostname in the URI is the name of the data source that you declared.</li>
<li>The path in the URI is passed to the command as an environment variable called <code>__DS_PATH__</code>.</li>
<li>The command also gets another environment variable called <code>__DS_NAME__</code> that is set to the data source name.</li>
</ul>
<p>A simple command may not respect the <code>__DS_PATH__</code> environment variable and always output the same data.
On the other hand, you can write a more complex integration (say, with Vault) by having the command use the
information in the <code>__DS_PATH__</code> variable and emit secrets specific to that path.</p>
<h2 id="usage-notes">Usage notes</h2>
<ul>
<li>
<p>Commands should output valid JSON or jsonnet when using <code>import data://my-source</code> but they can output any string
(e.g. YAML) when called as <code>importstr data://my-source</code>. It is up to you to post-process the output (e.g. by using
<code>parseYaml</code>) in the latter case.</p>
</li>
<li>
<p>Commands should behave like functions providing the same output for the same set of inputs. In particular,
commands <strong>should not write files</strong> in the jsonnet source tree.</p>
</li>
<li>
<p>Commands are run using Go&rsquo;s <code>os/exec</code> package which means that they do <strong>not</strong> run under a shell.
You cannot use pipes and redirection.
If you want this functionality you need to run the command as
<code>[ 'sh', '-c', 'subcommand1 | subcommand2']</code>.
Better yet, write a shell script that does all this.</p>
</li>
<li>
<p>You are responsible for ensuring that the executable you are running comes from a trusted source. Do not pull
down executables off the internet without checking their SHA sums.</p>
</li>
<li>
<p>In like manner, you are responsible to ensure that everyone on the team is the using the same version of the
command that is invoked. One strategy is to download the command you want into a <code>.bin</code> directory using a
<code>Makefile</code> and run it from there. The Makefile downloads the same version of the command for different OS
environments and checks their SHA sums.</p>
</li>
<li>
<p>The command that is run does <strong>not</strong> inherit the OS environment from the qbec process unless <code>inheritEnv</code> is set to true.
Only the environment variables explicitly defined in the config, as well as <code>__DS_NAME__</code> and <code>__DS_PATH__</code> are set.</p>
</li>
</ul>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/reference/jsonnet-glob-importer/" title="Jsonnet glob importer"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/reference/component-evaluation/" title="Component evaluation" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/perfect-scrollbar.min.js"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js"></script>
    <script src="/js/jquery.sticky.js"></script>
    <script src="/js/featherlight.min.js"></script>
    <script src="/js/html5shiv-printshiv.min.js"></script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js"></script>
    <script src="/js/learn.js"></script>
    <script src="/js/hugo-learn.js"></script>

    <link href="/mermaid/mermaid.css" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

